---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navbar from '../components/Navbar.astro';
import Hero from '../components/Hero.astro';
import Experience from '../components/Experience.astro';
import Sidebar from '../components/Sidebar.astro';
import Projects from '../components/Projects.astro';
import TwoColumnLayout from '../components/TwoColumnLayout.astro';
import Contact from '../components/Contact.astro';
import Footer from '../components/Footer.astro';

function parseCount(str: string): number {
  str = str.trim().toLowerCase();
  if (str.endsWith('k')) return Math.round(parseFloat(str) * 1000);
  if (str.endsWith('m')) return Math.round(parseFloat(str) * 1000000);
  return parseInt(str.replace(/,/g, ''), 10);
}

async function fetchPyPIDownloads(packageName: string): Promise<number> {
  try {
    const res = await fetch(`https://img.shields.io/pepy/dt/${packageName}`);
    const svg = await res.text();
    const match = svg.match(/aria-label="downloads:\s*([^"]+)"/);
    return match ? parseCount(match[1]) : 0;
  } catch { return 0; }
}

async function fetchSkillsInstalls(): Promise<{ count: number; display: string }> {
  try {
    const res = await fetch('https://skills.sh/jeffallan/claude-skills');
    const html = await res.text();
    const match = html.match(/([\d,.]+[kKmM]?)[^a-z]*total\s*installs/i);
    if (!match) return { count: 0, display: '' };
    const count = parseCount(match[1]);
    const display = Math.round(count / 1000) + 'K';
    return { count, display };
  } catch { return { count: 0, display: '' }; }
}

const [badfiles, fitnessTools, skills] = await Promise.all([
  fetchPyPIDownloads('badfiles'),
  fetchPyPIDownloads('fitness-tools'),
  fetchSkillsInstalls(),
]);

const total = badfiles + fitnessTools + skills.count;
const totalFormatted = Math.floor(total / 1000).toLocaleString() + ',000';
---

<BaseLayout>
  <Navbar />

  <div class="container-fluid pt-5 pl-5 pr-5">
    <Hero />

    <div class="row">
      <Experience />
      <Sidebar />
    </div>

    <div class="row d-flex">
      <Projects skillsInstalls={skills.display} />
    </div>

    <TwoColumnLayout rowClass="align-items-center">
      <div slot="left">
        <img class="bio-headshot" src="/images/headshot.png" alt="Jeff Smolinski headshot" />
        <h3>Jeff Smolinski</h3>
        <p>
            Principal Consultant at Synergetic Solutions, specializing in secure platform
            engineering and GRC programs for organizations handling sensitive data. With an MS
            in Cybersecurity (Cyber Operations) from UNO, he has led platforms achieving $1M ARR
            in their first year of operation, implemented SOC 2/HIPAA compliance programs, and
            secured $375K+ in grant funding. As a security researcher, he has disclosed two CVEs
            impacting 249 repositories and published peer-reviewed research on software
            fingerprinting. His open-source projects have over {totalFormatted} downloads combined.
          </p>
      </div>
      <div slot="right">
        <h2 id="ContactMe">Get In Touch</h2>
        <Contact />
      </div>
    </TwoColumnLayout>
  </div>

  <Footer />
</BaseLayout>
